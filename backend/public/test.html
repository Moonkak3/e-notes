<!-- TODO remove me -->
<!-- The core Firebase JS SDK is always required and must be listed first -->
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>

<pre id="displayName"></pre>
<pre id="email"></pre>
<pre id="photoURL"></pre>

<br>
<pre id="idToken"></pre>

<label for="uid">User ID: </label><input id="uid" placeholder="uid"/><br>
<label for="cid">Collection ID:</label> <input id="cid" placeholder="cid"/><br>
<span>users</span>
<button onclick="getUsers()">Get users</button>
<button onclick="me()">Get me</button>
<button onclick="getUser(document.getElementById('uid').value)">Get user</button>
<br>
<span>collections</span>
<button onclick="allColls()">All collection</button>
<button onclick="readColl()">Read collection</button>
<button onclick="makeColl()">Make collection</button>
<button onclick="killColl()">Kill collection</button>
<br>
<span>roles</span>
<button onclick="readNotes()">Read notes</button>
<button onclick="makeNote()">make note</button>
<br>
<span>roles</span>
<button onclick="makeRole()">Test role</button>
<button onclick="giveRolePerm()">Give perm to role</button>
<button onclick="giveRoleToUser()">Give role to user</button>
<br>
<button onclick="signIn()">Sign IN</button>
<button onclick="signOut()">Sign OUT</button>
<pre id="apiResults"></pre>
<script>
    let idTokenDOM = document.getElementById('idToken');
    let apiResults = document.getElementById('apiResults');

    function allColls() {
        fetcher("/api/collections");
    }

    function readColl() {
        fetcher("/api/collections/test");
    }

    function makeColl() {
        fetcher("/api/collections/test", {
            method: 'POST',
            body: JSON.stringify({
                name: "Test Test Test",
                desc: "Purely for testing purposes"
            })
        });
    }

    function killColl() {
        fetcher("/api/collections/test", {method: 'DELETE'});
    }

    function readNotes() {
        fetcher("/api/collections/test/notes");
    }

    function makeNote() {
        fetcher("/api/collections/test/notes/note1", {
            method: 'POST', body: JSON.stringify({
                name: "Test Test Test",
                desc: "Purely for testing purposes"
            })
        });
    }

    var firebaseConfig = {
        apiKey: "AIzaSyARHcPTpQ09ekeN91DtgfrAl8kA3bgrcYM",
        authDomain: "e-notes-nush.firebaseapp.com",
        databaseURL: "https://e-notes-nush.firebaseio.com",
        projectId: "e-notes-nush",
        storageBucket: "e-notes-nush.appspot.com",
        messagingSenderId: "1002111194265",
        appId: "1:1002111194265:web:24a8837e5d910ebcd11408",
        measurementId: "G-5CEEWG9PZR"
    };

    function getUsers() {
        fetcher("/api/users");
    }

    function getUser(uid) {
        fetcher("/api/users/" + uid);
    }

    function me() {
        fetcher("/api/users/me");
    }

    function makeRole() {
        fetcher("/api/roles/test", {
            method: 'POST',
            body: JSON.stringify({
                name: "Test Role",
                desc: "Very powerful role"
            })
        });
    }

    function giveRolePerm() {
        fetcher("/api/roles/test/grant/" + document.getElementById('cid').value);
    }

    function giveRoleToUser() {
        fetcher("/api/users/" + document.getElementById('uid').value + "/admin/role", {
            method: 'POST',
            body: JSON.stringify({
                rid: "test"
            })
        });
    }

    firebase.initializeApp(firebaseConfig);
    firebase.auth().onAuthStateChanged(function (user) {
        let keys = ['displayName', 'email', 'photoURL'];
        if (user) {
            keys.forEach(key => document.getElementById(key).innerText = user[key]);
            firebase.auth().currentUser.getIdToken(true).then(function (idToken) {
                idTokenDOM.innerText = idToken;
                localStorage.jwt = idToken;
            }).catch(function (error) {
                console.log("died");
            });
        } else keys.forEach(key => document.getElementById(key).innerText = "NULL");
    });

    function signIn() {
        const provider = new firebase.auth.OAuthProvider('microsoft.com');
        console.log(firebase.auth().currentUser);
        firebase.auth().signInWithPopup(provider);
    }

    function signOut() {
        firebase.auth().signOut();
    }

    function updateOptions(options) {
        const update = {...options};
        if (localStorage.jwt) {
            update.headers = {
                ...update.headers,
                'Authorization': localStorage.jwt
            };
            if (!update.headers['Content-Type']) update.headers['Content-Type'] = 'application/json';
        }
        return update;
    }

    function fetcher(url, options) {
        return fetch(url, updateOptions(options)).then(res => res.json())
            .then(res => apiResults.innerText = JSON.stringify(res, null, 4))
            .catch(err => apiResults.innerText = JSON.stringify(err, null, 4));
    }
</script>